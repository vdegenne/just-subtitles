<!doctype html>
<html>

<head></head>

<body>
  <style>
    body {
      margin: 0;
      display: flex;
      flex-direction: column;
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
    }

    video {
      width: 100%;
      height: 85px;
    }

    video::-webkit-media-controls-panel {
      display: flex !important;
      opacity: 1 !important;
    }

    textarea {
      display: block;
      flex: 1;
      width: 70%;
      margin: 0 auto;
      box-sizing: border-box;
    }

    #saved {
      font-family: Arial, Helvetica, sans-serif;
      position: absolute;
      bottom: 0;
      left: 0;
    }

    .hide {
      display: none;
    }
  </style>
  <video id="video" src="/%videopath%" controls></video>
  <textarea id="textarea" autofocus></textarea>
  <div id="saved" class="hide">saved</div>

  <script type="module">
    import { TimeCode, TimeCodeSpan } from '/timecode.js'

    window.onload = async () => {
      window.filebase = window.location.pathname.split('/').slice(2).join('/')
      fetch(`/files/${filebase}/captions.sbv`).then(async res => {
        if (res.status !== 200) {
          throw new Error('404')
        }
        textarea.value = await res.text()
      }).catch(err => { });
    }

    window.addEventListener('keydown', e => {
      // console.log(e.keyCode);

      /* toggle play/pause */
      if (e.ctrlKey && e.keyCode === 32) {
        e.preventDefault()
        const timecode = getCursorTimeCodeSpan()
        if (timecode) {
          video.currentTime = timecode.start.toSeconds()
          if (timecode.end) {
            video.playUntil = timecode.end.toSeconds();
          }
        }

        if (video.paused) {
          playVideo()
          video.playedFromShift = true
        }
        else if (!video.paused && !timecode) {
          pauseVideo()
        }
      }
      /* back 2 seconds */
      if (e.shiftKey && e.keyCode === 37) {
        e.preventDefault()
        video.currentTime -= 2
      }
      /* forward 2 seconds */
      if (e.shiftKey && e.keyCode === 39) {
        e.preventDefault()
        video.currentTime += 2
      }

      /** add start timecode on cursor position */
      if (e.altKey && e.key === 's') {
        e.preventDefault();
        const cursorPos = textarea.selectionStart
        textarea.value =
          `${textarea.value.substring(0, textarea.selectionStart)}${(new TimeCode(video.currentTime)).toString()}${textarea.value.substring(textarea.selectionStart)}`
        textarea.selectionStart = cursorPos
        textarea.selectionEnd = cursorPos
      }
      /** just pause and play the video */
      if (e.shiftKey && e.keyCode === 32) {
        e.preventDefault()
        video.playUntil = undefined
        video.paused ? playVideo() : pauseVideo()
      }

      /** recenter textarea */
      if (e.ctrlKey && e.key === 'l') {
        e.preventDefault()
        textarea.scrollTo(0, textarea.scrollTop + 20);
      }

      /** saving */
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault()
        fetch(`/save-subtitles/${filebase}`, {
          method: 'POST',
          body: `subtitles=${textarea.value}`,
          headers: {
            'content-type': 'application/x-www-form-urlencoded'
          }
        }).then(res => {
          if (res.status !== 200) {
            throw new Error('something went wrong')
          }
          saved.classList.remove('hide');
          if (window.savedTimeout) {
            clearTimeout(window.savedTimeout)
            window.savedTimeout = undefined
          }
          window.savedTimeout = setTimeout(() => {
            saved.classList.add('hide');
          }, 5000);
        }).catch(err => {
          alert('something went wrong')
        })
      }
    });

    const getCursorTimeCodeSpan = () => {
      const substring = textarea.value.substring(0, textarea.selectionStart + 8);
      const regexp = new RegExp(TimeCodeSpan.regexp, 'g');
      const results = substring.match(regexp);
      if (results) {
        return new TimeCodeSpan(results[results.length - 1])
      }
      else {
        return null
      }
    }
    window.getCursorTimeCodeSpan = getCursorTimeCodeSpan;

    const seekToCursorStartTimeCode = () => {
      const timecode = getCursorTimeCodeSpan()
      if (timecode) {
        video.currentTime = timecode.start.toSeconds()
      }
    }


    let videoWhilePlayingInterval;
    const videoWhilePlaying = () => {
      if (!video.paused && video.playUntil && video.currentTime > video.playUntil) {
        pauseVideo()
      }
    }

    const playVideo = () => {
      video.play()
      videoWhilePlayingInterval = setInterval(videoWhilePlaying, 50)
    }
    const pauseVideo = () => {
      video.pause()
      clearInterval(videoWhilePlayingInterval)
      videoWhilePlayingInterval = undefined
    }
  </script>
</body>

</html>